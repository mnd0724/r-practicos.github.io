# 1. CARGAR PAQUETES Y EXPLORACION INICIAL----------------

pacman::p_load(sjlabelled,
               dplyr, #Manipulacion de datos
               stargazer, #Tablas
               sjmisc, # Tablas
               summarytools, # Tablas
               kableExtra, #Tablas
               sjPlot, #Tablas y gráficos
               corrplot, # Correlaciones
               sessioninfo, # Información de la sesión de trabajo
               ggplot2) # Para la mayoría de los gráficos
load(url("https://github.com/Kevin-carrasco/R-data-analisis/raw/main/files/data/latinobarometro_total.RData")) #Cargar base de datos 
names(proc_data) # Muestra los nombres de las variables de la base de datos
dim(proc_data) # Dimensiones

# 2. VISUALIZACION DE VARIABLES ------------------

stargazer(proc_data,type = "text")
sjmisc::descr(proc_data)
sjmisc::descr(proc_data,
              show = c("label","range", "mean", "sd", "NA.prc", "n"))%>%
  kable(.,"markdown")
summarytools::dfSummary(proc_data, plain.ascii = FALSE)

view(dfSummary(proc_data, headings=FALSE)) #Tabla como imagen

proc_data_original <- proc_data #copiar la base de datos
dim(proc_data) #explorar data procesada ## [1] 20204     9
sum(is.na(proc_data)) #ver los casos perdidos # [1] 4005
proc_data <-na.omit(proc_data) #Limpiar la base de datos 
dim(proc_data) #ver la data sin los NA #[1] 18765     9

proc_data <-sjlabelled::copy_labels(proc_data,proc_data_original)

ggplot()
ggplot(proc_data, aes(x = conf_inst))
proc_data %>% ggplot(aes(x = conf_inst)) + 
  geom_bar()
proc_data %>% ggplot(aes(x = conf_inst)) + 
  geom_bar(fill = "pink")
proc_data %>% ggplot(aes(x = conf_inst)) + 
  geom_bar(fill = "pink")+
  labs(title = "Confianza en instituciones",
       x = "Confianza en instituciones",
       y = "Frecuencia")

## 2.2 Crear el gráfico usando ggplot2 ------------
graph1 <- proc_data %>% ggplot(aes(x = conf_inst)) + 
  geom_bar(fill = "violetred1")+
  labs(title = "Confianza en instituciones",
       x = "Confianza en instituciones",
       y = "Frecuencia") +
  theme_bw()

graph1

### 2.3 guardar ------------

ggsave(graph1, file="files/img/graph1.png")

# 3. TABLAS DE CONTINGENCIAS PARA VARIABLES CATEGORICAS ------------------
sjt.xtab(proc_data$educacion, proc_data$sexo)
sjt.xtab(proc_data$educacion, proc_data$sexo,
         show.col.prc=TRUE,
         show.summary=FALSE,
         encoding = "UTF-8"
)

# 4. TABLAS DE PROMEDIOS DE VARIABLE CONTINUA POR UNA CATEGORIA --------
#En ejemplo vamos a explorar datos de nuestra variable de
#confianza en instituciones conf_inst por los niveles educacionales educacion.
#Una forma rápida de explorar esto es mediante la función tapply, que nos entrega 
#de manera simple el promedio de una variable por otra:

tapply(proc_data$conf_inst, proc_data$educacion, mean)

proc_data %>% # se especifica la base de datos
  select(conf_inst,educacion) %>% # se seleccionan las variables
  dplyr::group_by(Educación=sjlabelled::as_label(educacion)) %>% # se agrupan por la variable categórica y se usan sus etiquetas con as_label
  dplyr::summarise(Obs.=n(),Promedio=mean(conf_inst),SD=sd(conf_inst)) %>% # se agregan las operaciones a presentar en la tabla
  kable(., format = "markdown") # se genera la tabla

graph <- ggplot(proc_data, aes(x =educacion, y = conf_inst)) +
  geom_boxplot() +
  labs(x = "Educación", y = "Confianza en instituciones") +
  theme_minimal()

graph

# y lo podemos guardar:

ggsave(graph, file="files/img/graph.png")

ggplot(proc_data, aes(x =educacion, y = conf_inst)) +
  geom_point() +
  labs(x = "Educación", y = "Confianza en instituciones") +
  theme_minimal()

datos <- proc_data %>% group_by(educacion) %>% 
  summarise(promedio = mean(conf_inst))

ggplot(datos, aes(x =educacion, y = promedio)) +
  geom_point() +
  labs(x = "Educación", y = "Confianza en instituciones") +
  theme_minimal()+
  ylim(0, 12)


proc_data$idenpa <- factor(proc_data$idenpa,
                           labels=c("Argentina",
                                    "Bolivia",
                                    "Brasil",
                                    "Chile",
                                    "Colombia",
                                    "Costa Rica",
                                    "Cuba",
                                    "República Dominicana",
                                    "Ecuador",
                                    "El Salvador",
                                    "Guatemala",
                                    "Honduras",
                                    "México",
                                    "Nicaragua",
                                    "Panamá",
                                    "Paraguay",
                                    "Uruguay",
                                    "Venezuela"),
                           levels=c("32",
                                    "68",
                                    "76",
                                    "152",
                                    "170",
                                    "188",
                                    "214",
                                    "218",
                                    "222",
                                    "320",
                                    "340",
                                    "484",
                                    "558",
                                    "591",
                                    "600",
                                    "604",
                                    "858",
                                    "862"))


graph_box <- ggplot(proc_data, aes(x = idenpa, y = conf_inst)) +
  geom_boxplot() +
  labs(x = "País", y = "Confianza en instituciones") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotar las etiquetas del eje x

graph_box

#ESCALA LIKERT
graph2 <- sjPlot::plot_stackfrq(dplyr::select(proc_data, conf_gob,
                                              conf_cong,
                                              conf_jud,
                                              conf_partpol),
                                title = "Confianza en instituciones políticas") +
  theme(legend.position="bottom")

graph2


colores_personalizados <- c("Hombre" = "blue", 
                            "Mujer" = "violetred1") 

graph3 <- proc_data %>% 
  ggplot(aes(x = conf_inst, fill = sexo)) + 
  geom_bar() +
  xlab("Confianza en instituciones") +
  ylab("Cantidad") + 
  labs(fill = "Sexo") +
  scale_fill_manual(values = colores_personalizados)

graph3

proc_data %>% ggplot(aes(x = conf_inst)) + 
  geom_bar(fill = "violetred1") +
  xlab("Confianza en instituciones") +
  ylab("Cantidad")+
  facet_wrap(~sexo)
